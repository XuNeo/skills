---
description: Commit NuttX changes with format check and optimized message
argument-hint: "<JIRA-number> [optional commit reference]"
allowed-tools: Bash(git:*), Bash(cd:*), Bash(tools/checkpatch.sh:*), Read, Grep
---

# NuttX Git Commit with Format Check

Commit changes to the NuttX repository with automatic code format checking and optimized commit message generation.

## Parameters

- **$1** (required): JIRA issue number (e.g., `123` or `VELAPLATFO-123`)
- **$2** (optional): Your commit message reference/draft - will be optimized based on code changes

## Workflow

### Step 1: Check Git Status

Navigate to the nuttx directory and verify there are changes to commit:

```bash
cd nuttx && git status
```

If no changes are staged or modified, inform the user and stop.

### Step 2: Get Code Changes

Retrieve the diff to understand what changes are being committed:

```bash
cd nuttx && git diff HEAD
```

### Step 3: Run Code Format Check

**CRITICAL**: Run NuttX's checkpatch.sh to verify code formatting compliance:

```bash
cd nuttx && git diff HEAD | tools/checkpatch.sh -
```

**Important**:
- If checkpatch.sh reports errors or warnings, display them clearly to the user
- Ask the user if they want to proceed with the commit despite format issues
- Only continue to the next step if the user confirms or if there are no issues

### Step 4: Generate Optimized Commit Message

Analyze the code changes and generate a commit message following NuttX conventions:

**Format Template**:
```
<component>: <optimized brief summary>
VELAPLATFO-$1

<detailed description based on code diff and user's input reference>

Signed-off-by: [will be auto-generated by git commit -s]
```

**Guidelines**:
- **Line 1**: Identify the affected component (e.g., `drivers/serial`, `arch/arm`, `fs/vfs`) and write a concise summary (under 72 characters)
- **Line 3**: Empty line
- **Line 4**: Must be `VELAPLATFO-{JIRA_NUMBER}` where JIRA_NUMBER is extracted from $1 (if user provides `VELAPLATFO-123`, use `123`; if user provides `123`, use `123`)
- **Line 5**: Empty line
- **Lines 6+**: Detailed description combining:
  - Analysis of the code changes from the diff
  - User's input from $2 (if provided) as reference
  - Why the change is needed
  - What problem it solves
- Use present tense (e.g., "Fix bug" not "Fixed bug")
- Wrap lines at 72 characters

**Optimization Requirements**:
- If user provided $2, use it as a reference but improve clarity, grammar, and technical accuracy
- Ensure the message accurately reflects the actual code changes in the diff
- Add technical details that may be missing from user's input
- Keep it concise but informative

### Step 5: Create Signed Commit

Execute the commit with the `-s` flag for automatic sign-off:

```bash
cd nuttx && git commit -s -m "<generated commit message>"
```

Use a HEREDOC for proper multi-line message formatting:

```bash
cd nuttx && git commit -s -m "$(cat <<'EOF'
<generated commit message with proper line breaks>
EOF
)"
```

### Step 6: Verify Commit

Show the created commit to confirm success:

```bash
cd nuttx && git log -1 --pretty=fuller
```

## Error Handling

- **No changes**: If git status shows no changes, inform user and exit
- **Format check failures**: Display all checkpatch.sh errors/warnings and require user confirmation
- **Missing JIRA number**: If $1 is not provided, prompt the user for it
- **Commit failures**: Display the error and suggest corrections

## Example Usage

```bash
# With JIRA number only (auto-generate commit message)
/git-commit-nuttx 123

# With JIRA number and reference message
/git-commit-nuttx VELAPLATFO-456 "fix serial driver bug"

# Full example with reference
/git-commit-nuttx 789 "update UART configuration to support higher baud rates"
```

## Notes

- The command automatically navigates to the `nuttx/` directory
- All git operations are performed within the nuttx repository
- The `-s` flag automatically adds your `Signed-off-by` line based on git config
- Format check uses `tools/checkpatch.sh` which is NuttX's standard linting tool
