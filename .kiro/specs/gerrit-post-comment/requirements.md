# Requirements Document

## Introduction

本功能为 gerritcomment skill 添加发布评论（post comment）能力，允许用户通过命令行向 Gerrit change 的特定 revision 发布评论。支持整体评论、行内评论、回复评论、设置标签和投票等功能。

## Glossary

- **Gerrit_Client**: 与 Gerrit 服务器通信的 Python 客户端
- **Change**: Gerrit 中的一个代码变更请求
- **Revision**: Change 的一个特定版本（patch set）
- **Inline_Comment**: 针对特定文件和行的评论
- **Review_Message**: 整体的评审消息
- **Label**: 投票标签，如 Code-Review、Verified 等
- **Comment_Thread**: 评论线程，包含原始评论和回复

## Requirements

### Requirement 1: 发布整体评审消息

**User Story:** As a reviewer, I want to post a general review message to a change, so that I can provide overall feedback.

#### Acceptance Criteria

1. WHEN a user provides a change reference and a message, THE Post_Comment_Script SHALL post the message as a review comment to the specified change
2. WHEN a user specifies a revision, THE Post_Comment_Script SHALL post the comment to that specific revision
3. WHEN no revision is specified, THE Post_Comment_Script SHALL post the comment to the current (latest) revision
4. IF the change does not exist, THEN THE Post_Comment_Script SHALL return an error with a descriptive message

### Requirement 2: 发布行内评论

**User Story:** As a reviewer, I want to post inline comments on specific lines of code, so that I can provide precise feedback on code changes.

#### Acceptance Criteria

1. WHEN a user provides a file path and line number with a message, THE Post_Comment_Script SHALL create an inline comment at that location
2. WHEN a user provides a range (start_line, start_character, end_line, end_character), THE Post_Comment_Script SHALL create a range comment covering that code section
3. WHEN a user provides only a file path without line number, THE Post_Comment_Script SHALL create a file-level comment
4. IF the specified file does not exist in the change, THEN THE Post_Comment_Script SHALL return an error

### Requirement 3: 回复现有评论

**User Story:** As a reviewer, I want to reply to existing comments, so that I can participate in code review discussions.

#### Acceptance Criteria

1. WHEN a user provides an in_reply_to comment ID, THE Post_Comment_Script SHALL create the comment as a reply to that comment
2. WHEN replying to a comment, THE Post_Comment_Script SHALL inherit the file and location context from the parent comment if not explicitly specified
3. IF the referenced comment ID does not exist, THEN THE Post_Comment_Script SHALL return an error

### Requirement 4: 设置评论状态

**User Story:** As a reviewer, I want to mark comments as resolved or unresolved, so that I can track which issues need attention.

#### Acceptance Criteria

1. WHEN a user sets unresolved to true, THE Post_Comment_Script SHALL mark the comment as requiring attention
2. WHEN a user sets unresolved to false, THE Post_Comment_Script SHALL mark the comment as resolved
3. THE Post_Comment_Script SHALL default unresolved to true for new comments (not replies)

### Requirement 5: 设置投票标签

**User Story:** As a reviewer, I want to set vote labels on a change, so that I can approve or request changes.

#### Acceptance Criteria

1. WHEN a user provides labels with voting values, THE Post_Comment_Script SHALL apply those votes to the change
2. WHEN multiple labels are provided, THE Post_Comment_Script SHALL apply all labels in a single request
3. IF a label name is invalid or the user lacks permission, THEN THE Post_Comment_Script SHALL return an error

### Requirement 6: 设置评论标签

**User Story:** As an automated system, I want to tag my comments, so that they can be distinguished from human reviews.

#### Acceptance Criteria

1. WHEN a user provides a tag value, THE Post_Comment_Script SHALL apply that tag to the review
2. THE Post_Comment_Script SHALL support tags with 'autogenerated:' prefix for automated systems

### Requirement 7: 批量发布多个行内评论

**User Story:** As a reviewer, I want to post multiple inline comments at once, so that I can efficiently review code.

#### Acceptance Criteria

1. WHEN a user provides multiple comments via JSON input, THE Post_Comment_Script SHALL post all comments in a single API request
2. THE Post_Comment_Script SHALL support comments on different files in the same request
3. IF any comment in the batch fails validation, THEN THE Post_Comment_Script SHALL report which comments failed

### Requirement 8: 输出结果

**User Story:** As a user, I want to see the result of my comment submission, so that I can confirm it was successful.

#### Acceptance Criteria

1. WHEN a comment is successfully posted, THE Post_Comment_Script SHALL output a JSON response with success status
2. WHEN an error occurs, THE Post_Comment_Script SHALL output a JSON response with error details
3. THE Post_Comment_Script SHALL include the change number and revision in the response
