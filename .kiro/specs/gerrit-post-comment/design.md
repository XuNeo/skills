# Design Document: Gerrit Post Comment

## Overview

本设计文档描述了 gerrit-post-comment 功能的技术实现方案。该功能通过 Python 脚本调用 Gerrit REST API，实现向 Gerrit change 发布评论的能力。

设计遵循现有 `get_comments.py` 的架构风格，保持代码一致性，复用已有的配置和错误处理机制。

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                    post_comment.py                          │
├─────────────────────────────────────────────────────────────┤
│  CLI Layer (argparse)                                       │
│  ├── --change: Change URL/number/ID                         │
│  ├── --revision: Target revision                            │
│  ├── --message: Review message                              │
│  ├── --file: Target file path                               │
│  ├── --line: Line number                                    │
│  ├── --range: Line range (JSON)                             │
│  ├── --reply-to: Comment ID to reply                        │
│  ├── --unresolved: Mark as unresolved                       │
│  ├── --labels: Vote labels (JSON)                           │
│  ├── --tag: Comment tag                                     │
│  └── --comments-json: Batch comments (JSON file/string)     │
├─────────────────────────────────────────────────────────────┤
│  Business Logic Layer                                       │
│  ├── build_review_input(): Construct ReviewInput entity     │
│  ├── build_comment_input(): Construct CommentInput entity   │
│  └── post_review(): Execute API call                        │
├─────────────────────────────────────────────────────────────┤
│  Shared Utilities (from get_comments.py)                    │
│  ├── parse_change_url(): Parse Gerrit URL                   │
│  ├── get_config(): Load environment config                  │
│  └── GerritError: Custom exception                          │
├─────────────────────────────────────────────────────────────┤
│  External Dependencies                                      │
│  └── python-gerrit-api (GerritClient)                       │
└─────────────────────────────────────────────────────────────┘
```

## Components and Interfaces

### 1. CLI Interface

命令行参数设计：

```bash
python3 post_comment.py --change "<change>" [options]

# 必需参数
--change          Change URL, number, or Change-Id

# 可选参数 - 基本
--revision        Target revision (SHA, patch set number, or 'current')
--message         Review message (overall comment)
--tag             Tag for the review (e.g., 'autogenerated:ci')

# 可选参数 - 行内评论
--file            File path for inline comment
--line            Line number for inline comment
--range           Range as JSON: {"start_line":1,"start_character":0,"end_line":5,"end_character":10}
--reply-to        Comment ID to reply to
--unresolved      Mark comment as unresolved (flag, default: true for new)
--resolved        Mark comment as resolved (flag)

# 可选参数 - 投票
--labels          Labels as JSON: {"Code-Review": 1, "Verified": 1}

# 可选参数 - 批量
--comments-json   JSON string or @file with multiple comments
```

### 2. ReviewInput Builder

```python
def build_review_input(
    message: str | None = None,
    tag: str | None = None,
    labels: dict[str, int] | None = None,
    comments: dict[str, list[dict]] | None = None,
) -> dict:
    """
    构建 ReviewInput 实体。
    
    Args:
        message: 整体评审消息
        tag: 评论标签
        labels: 投票标签 {label_name: vote_value}
        comments: 行内评论 {file_path: [CommentInput, ...]}
    
    Returns:
        ReviewInput 字典，可直接传递给 revision.set_review()
    """
```

### 3. CommentInput Builder

```python
def build_comment_input(
    message: str,
    line: int | None = None,
    range_: dict | None = None,
    in_reply_to: str | None = None,
    unresolved: bool | None = None,
    side: str = "REVISION",
) -> dict:
    """
    构建 CommentInput 实体。
    
    Args:
        message: 评论内容
        line: 行号（1-based）
        range_: 范围 {start_line, start_character, end_line, end_character}
        in_reply_to: 回复的评论 ID
        unresolved: 是否标记为未解决
        side: REVISION 或 PARENT
    
    Returns:
        CommentInput 字典
    """
```

### 4. Post Review Function

```python
def post_review(
    base_url: str,
    change_ref: str,
    revision: str | None,
    review_input: dict,
) -> dict:
    """
    发布评审到 Gerrit。
    
    Args:
        base_url: Gerrit 服务器 URL
        change_ref: Change number 或 Change-Id
        revision: 目标 revision（默认 'current'）
        review_input: ReviewInput 实体
    
    Returns:
        API 响应结果
    
    Raises:
        GerritError: API 调用失败时
    """
```

## Data Models

### ReviewInput Entity

```python
ReviewInput = {
    "message": str,           # 可选，整体评审消息
    "tag": str,               # 可选，评论标签
    "labels": {               # 可选，投票
        "label_name": int     # 如 "Code-Review": 1
    },
    "comments": {             # 可选，行内评论
        "file/path.py": [     # 文件路径作为 key
            CommentInput,     # 评论列表
            ...
        ]
    }
}
```

### CommentInput Entity

```python
CommentInput = {
    "message": str,           # 评论内容
    "line": int,              # 可选，行号（1-based）
    "range": {                # 可选，范围
        "start_line": int,    # 起始行（1-based，inclusive）
        "start_character": int,  # 起始字符（0-based，inclusive）
        "end_line": int,      # 结束行（1-based，exclusive）
        "end_character": int  # 结束字符（0-based，exclusive）
    },
    "in_reply_to": str,       # 可选，回复的评论 ID
    "unresolved": bool,       # 可选，是否未解决
    "side": str               # 可选，REVISION 或 PARENT
}
```

### Batch Comments JSON Format

```json
{
    "message": "Overall review message",
    "tag": "autogenerated:my-tool",
    "labels": {
        "Code-Review": 1
    },
    "comments": {
        "src/main.py": [
            {
                "line": 10,
                "message": "Consider using a constant here"
            },
            {
                "range": {
                    "start_line": 20,
                    "start_character": 0,
                    "end_line": 25,
                    "end_character": 0
                },
                "message": "This block could be refactored"
            }
        ],
        "src/utils.py": [
            {
                "line": 5,
                "message": "Missing docstring",
                "unresolved": true
            }
        ]
    }
}
```



## Correctness Properties

*A property is a characteristic or behavior that should hold true across all valid executions of a system—essentially, a formal statement about what the system should do. Properties serve as the bridge between human-readable specifications and machine-verifiable correctness guarantees.*

### Property 1: ReviewInput message construction

*For any* non-empty message string, when `build_review_input(message=msg)` is called, the resulting ReviewInput dictionary SHALL contain a "message" key with the exact input string as its value.

**Validates: Requirements 1.1**

### Property 2: CommentInput file and line construction

*For any* valid file path string and positive integer line number, when `build_comment_input(message=msg, line=n)` is called, the resulting CommentInput dictionary SHALL contain "message" with the input message and "line" with the exact line number.

**Validates: Requirements 2.1**

### Property 3: CommentInput range construction

*For any* valid range dictionary with start_line, start_character, end_line, end_character (all non-negative integers with start <= end), when `build_comment_input(message=msg, range_=range_dict)` is called, the resulting CommentInput dictionary SHALL contain a "range" key with all four fields matching the input.

**Validates: Requirements 2.2**

### Property 4: CommentInput reply construction

*For any* non-empty comment ID string, when `build_comment_input(message=msg, in_reply_to=id)` is called, the resulting CommentInput dictionary SHALL contain an "in_reply_to" key with the exact input ID.

**Validates: Requirements 3.1**

### Property 5: CommentInput unresolved flag handling

*For any* boolean value for unresolved, when `build_comment_input(message=msg, unresolved=flag)` is called, the resulting CommentInput dictionary SHALL contain an "unresolved" key with the exact boolean value. When unresolved is None and in_reply_to is None, the default SHALL be True.

**Validates: Requirements 4.1, 4.2, 4.3**

### Property 6: ReviewInput labels construction

*For any* non-empty dictionary of label names to integer vote values, when `build_review_input(labels=labels_dict)` is called, the resulting ReviewInput dictionary SHALL contain a "labels" key with all input label-value pairs preserved.

**Validates: Requirements 5.1**

### Property 7: ReviewInput tag construction

*For any* non-empty tag string, when `build_review_input(tag=tag_str)` is called, the resulting ReviewInput dictionary SHALL contain a "tag" key with the exact input string.

**Validates: Requirements 6.1**

### Property 8: Batch comments parsing round-trip

*For any* valid batch comments JSON structure, parsing it and then serializing the resulting ReviewInput back to JSON SHALL produce an equivalent structure (same message, tag, labels, and all comments with their properties preserved).

**Validates: Requirements 7.1**

### Property 9: Output format consistency

*For any* operation result (success or error), the output SHALL be valid JSON containing at minimum "change" key, and either "success" key (for success) or "error" key with "type" and "message" subkeys (for errors).

**Validates: Requirements 8.1, 8.2, 8.3**

## Error Handling

### Error Categories

| Error Type | HTTP Status | Description | User Message |
|------------|-------------|-------------|--------------|
| AuthenticationError | 401 | Invalid credentials | "Authentication failed (401)" |
| NotFoundError | 404 | Change/revision not found | "Change not found (404)" |
| ConflictError | 409 | Cannot post to change edit | "Cannot post review to change edit (409)" |
| PermissionError | 403 | Insufficient permissions | "Permission denied (403)" |
| ValidationError | N/A | Invalid input parameters | Specific validation message |

### Error Response Format

```json
{
    "change": "12345",
    "revision": "current",
    "error": {
        "type": "GerritError",
        "message": "Authentication failed (401)"
    }
}
```

## Testing Strategy

### Unit Tests

单元测试覆盖以下场景：

1. `build_review_input()` 函数
   - 仅 message 参数
   - 仅 labels 参数
   - 仅 tag 参数
   - 组合参数
   - 空参数（返回空字典）

2. `build_comment_input()` 函数
   - 仅 message（文件级评论）
   - message + line（行评论）
   - message + range（范围评论）
   - message + in_reply_to（回复）
   - unresolved 默认值逻辑

3. CLI 参数解析
   - 必需参数验证
   - JSON 参数解析
   - 文件路径参数（@file）

4. 错误处理
   - HTTP 错误转换
   - 验证错误消息

### Property-Based Tests

使用 `hypothesis` 库进行属性测试：

```python
from hypothesis import given, strategies as st

# Property 1: ReviewInput message construction
@given(st.text(min_size=1))
def test_review_input_message_property(message):
    result = build_review_input(message=message)
    assert result["message"] == message

# Property 2: CommentInput file and line construction
@given(st.text(min_size=1), st.integers(min_value=1))
def test_comment_input_line_property(message, line):
    result = build_comment_input(message=message, line=line)
    assert result["message"] == message
    assert result["line"] == line

# Property 5: Unresolved flag handling
@given(st.booleans())
def test_comment_input_unresolved_property(unresolved):
    result = build_comment_input(message="test", unresolved=unresolved)
    assert result["unresolved"] == unresolved
```

### Integration Tests

集成测试需要 Gerrit 测试服务器或 mock：

1. 成功发布评论
2. 成功发布带投票的评论
3. 成功批量发布评论
4. 错误处理（401, 404, 409）

### Test Configuration

- Property tests: minimum 100 iterations
- Test framework: pytest + hypothesis
- Tag format: **Feature: gerrit-post-comment, Property N: {property_text}**
